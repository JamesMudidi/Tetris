<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tetris &VerticalLine; Settings</title>
    <script src="js/settings.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/tetris.css">
</head>

<body>
    <nav id="toolbar">
        <a href="index.html"><img alt="Home" class="help" src="images/home.svg" /></a><br>
        <img alt="Help" id="id.help" class="help" src="images/help.svg" title="Help" /><br>
        <img alt="Close Help" id="id.close-help" class="close" src="images/close.svg" title="Help" />
        <img alt="Settings" id="id.settings" class="settings" src="images/settings.svg" title="Settings" />
    </nav>
    <div class="page">
        <div class="content">
            <div class="heading align">Settings</div>
            <div id="keyEditor"></div>
            <h4 class="align">Tetris Version.&ThinSpace;<span id="version"></span></h4>

            <main>
                <section>
                    <details open="true">
                        <summary>Game console size</summary>
                        <table class="default">
                            <tr>
                                <td>Horizontal:</td>
                                <td>
                                    <select data-property="gameSizeInBlocks.x"
                                        data-editor="gameSizeInBlocksEditor.x"></select>
                                </td>
                            </tr>
                            <tr>
                                <td>Vertical:</td>
                                <td>
                                    <select data-property="gameSizeInBlocks.y" data-editor="gameSizeInBlocksEditor.y">
                                </td>
                            </tr>
                        </table>
                    </details>
                    <details>
                        <summary>Game speed</summary>
                        <table class="default">
                            <tr>
                                <td>Start:</td>
                                <td>
                                    <select data-property="delays.start" data-editor="delaysEditor.start"></select>
                                </td>
                            <tr>
                                <td>Decrement:</td>
                                <td>
                                    <select data-property="delays.decrement"
                                        data-editor="delaysEditor.decrement"></select>
                                </td>
                            </tr>
                            <tr>
                                <td>Minimum:</td>
                                <td>
                                    <select data-property="delays.min" data-editor="delaysEditor.min"></select>
                                </td>
                            </tr>
                        </table>
                    </details>
                    <details>
                        <summary>Tile Color</summary>
                        <table class="colors">
                            <tr>
                                <td><img id="image.J" src="images/settings.J.png" /></td>
                                <td><select data-property="tetrominoColor.J"></select></td>
                            </tr>
                            <tr>
                                <td><img id="image.S" src="images/settings.S.png" /></td>
                                <td><select data-property="tetrominoColor.S"></select></td>
                            </tr>
                            <tr>
                                <td><img id="image.T" src="images/settings.T.png" /></td>
                                <td><select data-property="tetrominoColor.T"></select></td>
                            </tr>
                            <tr>
                                <td><img id="image.L" src="images/settings.L.png" /></td>
                                <td><select data-property="tetrominoColor.L"></select></td>
                            </tr>
                            <tr>
                                <td><img id="image.Z" src="images/settings.Z.png" /></td>
                                <td><select data-property="tetrominoColor.Z"></select></td>
                            </tr>
                            <tr>
                                <td><img id="image.O" src="images/settings.O.png" /></td>
                                <td><select data-property="tetrominoColor.O"></select></td>
                            </tr>
                            <tr>
                                <td><img id="image.I" src="images/settings.I.png" /></li>
                                <td><select data-property="tetrominoColor.I"></select></td>
                            </tr>
                        </table>
                    </details>
                    <details>
                        <summary>Clutter</summary>
                        <table class="default">
                            <tr>
                                <td><label for="clutterEnabledDefault">Enabled by default:</td>
                                <td><input type="checkbox" data-property="clutterOptionSet.clutterEnabledDefault"
                                        id="clutterEnabledDefault"></input></label></td>
                            </tr>
                            <tr>
                                <td>Minimum:</td>
                                <td><select data-property="clutterOptionSet.min"
                                        data-editor="clutterEditor.min"></select>
                                </td>
                            </tr>
                            <tr>
                                <td>Maximum:</td>
                                <td><select data-property="clutterOptionSet.max"
                                        data-editor="clutterEditor.max"></select>
                                </td>
                            </tr>
                            <tr>
                                <td>Step:</td>
                                <td><select data-property="clutterOptionSet.step"
                                        data-editor="clutterEditor.step"></select>
                                </td>
                            </tr>
                            <tr>
                                <td>Default value:</td>
                                <td><select data-property="clutterOptionSet.default"
                                        data-editor="clutterEditor.default"></select></td>
                            </tr>
                        </table>
                    </details>
                    <details>
                        <summary>Keyboard Settings</summary>
                        <table>
                            <tr data-property="key.start">
                                <td>Start/Pause/Continue:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.cancel">
                                <td>Cancel:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.left">
                                <td>Left:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.right">
                                <td>Right:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.down">
                                <td>Down:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.dropDown">
                                <td>Drop Down:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.rotate">
                                <td>Rotate:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.help">
                                <td>Help:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.downloadSource">
                                <td>Download source code:</td>
                                <td><input type="text"></td>
                            </tr>
                            <tr data-property="key.settings">
                                <td>Settings:</td>
                                <td><input type="text"></td>
                            </tr>
                        </table>
                    </details>
                    <button id="apply" title="Store custom settings and play game">Apply</button>
                    <button id="reset" title="Reset settings to default values">Reset</button>
                    <button id="clean" title="Clean Tetris data from browser local storage">Clear Cache</button>
                </section>
            </main>
            <script>

                "use strict";

                const setTargetImage = (node) => {
                    const cell = node.parentElement;
                    if (cell.constructor != HTMLTableCellElement) return;
                    let tetrominoName = node.dataset.property.split('.');
                    tetrominoName = tetrominoName[tetrominoName.length - 1];
                    const tetrominoId = "image." + tetrominoName;
                    const targetImage = document.getElementById(tetrominoId);
                    if (!targetImage) return null;
                    node.targetImage = targetImage;
                    return targetImage;
                }; //setTargetImage

                const detectKeyboardEditorElements = (node) => {
                    const numericKeyCodeElement = node.firstElementChild.nextSibling;
                    const button = node.lastElementChild.lastElementChild;
                    const inputName = node.lastElementChild.firstElementChild;
                    return { numericKeyCodeElement: numericKeyCodeElement, button: button, inputName: inputName };
                }; //detectKeyboardEditorElements

                const populate = (elements, defaultOnly) => {
                    const effectiveSettings = getSettings(defaultOnly);
                    const effectiveSettingsNamePrefix = settingsEditor.getVariableName({ effectiveSettings }) + ".";
                    settingsEditor.traverse(document.body, function (node) {
                        if (!node.dataset) return;
                        if (!node.dataset.property) return;
                        let value = eval(effectiveSettingsNamePrefix + node.dataset.property);
                        if (node.constructor == HTMLTableRowElement) { // keyboard
                            const keyboardEditorElements = detectKeyboardEditorElements(node);
                            keyboardEditorElements.numericKeyCodeElement.textContent = value.keyCode;
                            keyboardEditorElements.inputName.value = value.display;
                            keyboardEditorElements.inputName.data = {};
                            keyboardEditorElements.inputName.data.keyCode = value.keyCode;
                            keyboardEditorElements.button.onclick = () => {
                                elements.keyEditor.tabIndex = 0;
                                elements.keyEditor.onkeydown = (event) => {
                                    event.preventDefault();
                                    event.target.innerHTML = event.keyCode;
                                    keyboardEditorElements.inputName.value = event.code;
                                    keyboardEditorElements.inputName.data = {};
                                    keyboardEditorElements.inputName.data.keyCode = event.keyCode;
                                    event.target.style.display = "none";
                                    keyboardEditorElements.numericKeyCodeElement.textContent = event.keyCode;
                                    keyboardEditorElements.inputName.focus();
                                }; //elements.keyEditor
                                elements.keyEditor.innerHTML = settingsEditor.keyEditorInstruction;
                                elements.keyEditor.style.display = "block";
                                const buttonBounds = keyboardEditorElements.button.getBoundingClientRect();
                                elements.keyEditor.style.top = settingsEditor.sizeStyle((buttonBounds.top + window.pageYOffset));
                                elements.keyEditor.style.left = settingsEditor.sizeStyle((buttonBounds.right + window.pageXOffset));
                                elements.keyEditor.focus();
                            }; //keyboardEditorElements.button.onclick
                        } else if (node.constructor == HTMLSelectElement) {
                            while (node.firstChild)
                                node.removeChild(node.firstChild);
                            if (setTargetImage(node)) { // case of image
                                node.onchange = function (event) {
                                    if (event.target.targetImage.constructor == HTMLImageElement)
                                        event.target.targetImage.style.backgroundColor = event.target.value;
                                }; //node.onselect
                                for (let color of settingsEditor.namedCssColors) {
                                    const option = document.createElement("option");
                                    const colorBox = document.createElement("aside");
                                    colorBox.style.backgroundColor = color;
                                    const colorName = document.createTextNode(color);
                                    option.appendChild(colorBox);
                                    option.appendChild(colorName);
                                    option.selected = value.toLowerCase() == color.toLowerCase();
                                    option.value = color;
                                    node.add(option);
                                } //loop
                                node.targetImage.style.backgroundColor = node.value;
                            } else { //if image, now considering text
                                const editorOptionSet = eval(effectiveSettingsNamePrefix + node.dataset.editor);
                                if (!editorOptionSet) return;
                                const count = ((editorOptionSet.max - editorOptionSet.min) / editorOptionSet.step) + 1;
                                const rounder = settingsEditor.findRoundingFactor(editorOptionSet);
                                for (let index = 0; index < count; ++index) {
                                    let optionValue = editorOptionSet.min + index * editorOptionSet.step;
                                    optionValue = Math.floor(optionValue * rounder) / rounder;
                                    const option = document.createElement("option");
                                    option.selected = optionValue == value;
                                    option.textContent = optionValue + editorOptionSet.unit;
                                    node.add(option);
                                } //loop
                            } //if text
                        } else if (node.constructor == HTMLInputElement && node.type == "checkbox") {
                            node.checked = value;
                        } else // not editable
                            settingsEditor.setText(node.id, value);
                    });
                    return effectiveSettings.localStorageAccessible;
                }; //populate

                const extractKeyboardData = (node) => {
                    const parentProperty = eval(node.dataset.property)
                    const keyboardEditorElements = detectKeyboardEditorElements(node);
                    const keyCode = keyboardEditorElements.inputName.data.keyCode;
                    const display = keyboardEditorElements.inputName.value;
                    parentProperty.keyCode = keyCode;
                    parentProperty.display = display;
                    return parentProperty;
                }; //extractKeyboardData

                const apply = () => {
                    const target = {};
                    settingsEditor.traverse(document.body, function (node) {
                        if (!node.dataset) return;
                        if (!node.dataset.property) return;
                        if (node.constructor != HTMLTableRowElement && node.constructor != HTMLSelectElement && node.type != "checkbox") return;
                        const propertyChain = node.dataset.property.split(".");
                        let currentObject = target;
                        let lastSlot = null;
                        let value = null;
                        if (node.constructor == HTMLTableRowElement) {
                            value = extractKeyboardData(node);
                        } else {
                            value = node.value;
                            if (node.type == "checkbox")
                                value = node.checked;
                            else {
                                const numericValue = parseFloat(node.value);
                                if (!Number.isNaN(numericValue)) value = numericValue;
                            } //if
                        } //if
                        if (value == undefined || value == null) return;
                        for (let index = 0; index < propertyChain.length; ++index) {
                            if (currentObject[propertyChain[index]] != undefined)
                                currentObject = currentObject[propertyChain[index]];
                            else {
                                if (index == propertyChain.length - 1)
                                    currentObject[propertyChain[index]] = value;
                                else
                                    currentObject[propertyChain[index]] = {};
                                currentObject = currentObject[propertyChain[index]];
                            } //if
                        } //loop slots
                    });
                    const result = JSON.stringify(target);
                    localStorage.setItem(settingsEditor.localStorageKey, result);
                    window.location = fileNames.tetris;
                }; //apply

                window.onload = () => {
                    const elements = {
                        version: document.getElementById("version"),
                        keyEditor: document.getElementById("keyEditor"),
                        buttonApply: document.getElementById("apply"),
                        buttonClean: document.getElementById("clean"),
                        buttonReset: document.getElementById("reset"),
                        badBrowser: document.getElementById("badBrowser")
                    };
                    elements.version.textContent = version;
                    const localStorageAccessible = populate(elements, false);
                    elements.buttonReset.onclick = () => { populate(elements, true); };
                    if (localStorageAccessible) {
                        elements.buttonApply.onclick = apply;
                        elements.buttonClean.onclick = () => {
                            localStorage.removeItem(settingsEditor.localStorageKey);
                            location.reload(true);
                        }; //buttonClean.onclick
                    } else {
                        elements.badBrowser.innerHTML = settingsEditor.badBrowserHTML;
                        elements.badBrowser.parentElement.style.color = settingsEditor.badBrowserColor;
                        elements.buttonApply.disabled = true;
                        elements.buttonClean.disabled = true;
                    } //if
                }; //window.onload
            </script>

        </div>
    </div>
</body>

</html>